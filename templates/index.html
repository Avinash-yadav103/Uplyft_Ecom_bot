<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopAssist - E-Commerce Chatbot</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <h1>ShopAssist</h1>
        <nav>
            <ul>
                <li><a href="">Home</a></li>
                <li><a href="">Products</a></li>
                <li><a href="">Cart</a></li>
                <li><a href="">Account</a></li>
            </ul>
        </nav>
    </header>

    Search using AI feature
    Testing hatana and checks hatana

    <div class="openbox">
        <button class="open-chat-btn" onClick=toggleChat()>
            <i class="fas fa-comments"></i> Chat with us
        </button>
    </div>

    <main>
        <div class="user-profile">
            <div class="user-avatar">
                <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?ixlib=rb-1.2.1&auto=format&fit=crop&w=250&q=80" alt="User Avatar">
            </div>
            <div class="user-info">
                <h3>Welcome, Alex!</h3>
                <p>Premium Member since 2023</p>
            </div>
        </div>

        <div class="chatbot-container">
            <div class="chatbot-header">
                <div class="bot-logo">
                    <img src="https://cdn-icons-png.flaticon.com/512/2021/2021646.png" alt="ShopAssist Logo">
                    <span class="status-indicator"></span>
                </div>
                <div class="bot-info">
                    <h2>ShopAssist</h2>
                    <p>Online</p>
                </div>
                <button class="close-btn" onClick=toggleChat()>
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="chat-messages">
                <div class="message bot-message">
                    üëã Hi Alex! Welcome to our store. How can I help you today?
                </div>
                
                <!-- Quick Replies Section -->
                <div class="quick-replies">
                    <button class="quick-reply-btn" onclick=getCategories()>
                        <i class="fas fa-tshirt"></i> Browse Products
                    </button>
                    <button class="quick-reply-btn">
                        <i class="fas fa-tag"></i> Today's Deals
                    </button>
                    <button class="quick-reply-btn">
                        <a href='faq'><i class="fas fa-question-circle"></i> Help & FAQ</a>
                    </button>
                    <button class="quick-reply-btn">
                        <i class="fas fa-headset"></i> Contact Support
                    </button>
                    <button class="quick-reply-btn" onclick="downloadProductsJSON()">
                        <i class="fas fa-file-download"></i> Get Products JSON
                    </button>
                </div>

            </div>
            
            <div class="chat-input">
                <input type="text" placeholder="Type your message here..." aria-label="Chat message">
                <button type="submit">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </main>
    <script>
        // Enhanced product data loading with preload and retries
        let allProducts = null;
        let isLoadingProducts = false;
        let loadingAttempts = 0;
        const MAX_LOADING_ATTEMPTS = 3;

        // Preload products as soon as the page loads
        document.addEventListener('DOMContentLoaded', function() {
            preloadProductData();
            
            // Show loading indicator in the chat immediately
            const messagesContainer = document.querySelector('.chat-messages');
            const loadingIndicator = document.createElement('div');
            loadingIndicator.classList.add('message', 'bot-message', 'loading-indicator');
            loadingIndicator.innerHTML = 'Loading product data... <div class="loading-spinner"></div>';
            loadingIndicator.id = 'loading-indicator';
            messagesContainer.appendChild(loadingIndicator);
        });

        // Preload function with retry capability
        async function preloadProductData() {
            if (isLoadingProducts || allProducts) return;
            
            isLoadingProducts = true;
            loadingAttempts++;
            
            try {
                // First try to load from local file
                const response = await fetch('/static/products.json');
                if (!response.ok) {
                    throw new Error(`Failed to load products from local file: ${response.status}`);
                }
                
                allProducts = await response.json();
                console.log("Products data loaded successfully from local file");
                
                // Remove loading indicator if it exists
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
                
                // Show success message
                showBotMessage("Product data loaded successfully! How can I help you today?");
                
                // Enable all chat buttons
                enableChatInteractions();
                
                isLoadingProducts = false;
            } catch (error) {
                console.error("Error loading products from local file:", error);
                
                // Try loading from DummyJSON API as fallback
                try {
                    console.log("Attempting to load from DummyJSON API...");
                    const dummyResponse = await fetch('https://dummyjson.com/products?limit=100');
                    if (!dummyResponse.ok) {
                        throw new Error(`Failed to load products from API: ${dummyResponse.status}`);
                    }
                    
                    allProducts = await dummyResponse.json();
                    console.log("Products data loaded successfully from DummyJSON API");
                    
                    // Remove loading indicator if it exists
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.remove();
                    }
                    
                    // Show success message
                    showBotMessage("Product data loaded successfully! How can I help you today?");
                    
                    // Enable all chat buttons
                    enableChatInteractions();
                    
                    isLoadingProducts = false;
                } catch (apiError) {
                    console.error("Error loading products from API:", apiError);
                    
                    if (loadingAttempts < MAX_LOADING_ATTEMPTS) {
                        // Retry loading after delay
                        isLoadingProducts = false;
                        setTimeout(preloadProductData, 2000);
                        
                        // Update loading message
                        const loadingIndicator = document.getElementById('loading-indicator');
                        if (loadingIndicator) {
                            loadingIndicator.innerHTML = `Retrying product data load (${loadingAttempts}/${MAX_LOADING_ATTEMPTS})... <div class="loading-spinner"></div>`;
                        }
                    } else {
                        // Max retries reached, show error and add retry button
                        const loadingIndicator = document.getElementById('loading-indicator');
                        if (loadingIndicator) {
                            loadingIndicator.remove();
                        }
                        
                        showErrorMessage("Unable to load product data. Please refresh the page or try again later.");
                        addRetryButton();
                        enableChatInteractions(); // Enable chat even though loading failed
                        isLoadingProducts = false;
                    }
                }
            }
        }

        // Enable all chat buttons after data is loaded
        function enableChatInteractions() {
            const buttons = document.querySelectorAll('.quick-reply-btn');
            buttons.forEach(button => {
                button.disabled = false;
            });
        }

        // Add CSS for loading spinner
        const style = document.createElement('style');
        style.textContent = `
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        `;
        document.head.appendChild(style);

        // Override the getCategories function to check data status
        function getCategories() {
            if (!allProducts) {
                // If not loaded yet, try to load again
                if (!isLoadingProducts) {
                    preloadProductData();
                    showBotMessage("Loading product data now. Please wait a moment...");
                } else {
                    showBotMessage("Product data is still loading. Please wait a moment...");
                }
                return;
            }
            
            const messagesContainer = document.querySelector('.chat-messages');
            
            // Add user message
            const userMessage = document.createElement('div');
            userMessage.classList.add('message', 'user-message');
            userMessage.textContent = "I want to browse products";
            messagesContainer.appendChild(userMessage);
            
            // Create loading message
            const loadingMessage = document.createElement('div');
            loadingMessage.classList.add('message', 'bot-message');
            loadingMessage.textContent = "Finding product categories for you...";
            messagesContainer.appendChild(loadingMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            setTimeout(() => {
                // Remove loading message
                messagesContainer.removeChild(loadingMessage);
                
                // Extract unique categories
                let categories = [];
                if (allProducts.products) {
                    categories = [...new Set(allProducts.products.map(product => product.category))];
                } else if (Array.isArray(allProducts)) {
                    categories = [...new Set(allProducts.map(product => product.category))];
                }
                
                categories = categories.filter(category => category && category.trim() !== '').sort();
                
                // Create categories message
                const categoriesMessage = document.createElement('div');
                categoriesMessage.classList.add('message', 'bot-message');
                
                if (categories.length === 0) {
                    categoriesMessage.textContent = "I couldn't find any product categories. Please try again later.";
                    messagesContainer.appendChild(categoriesMessage);
                    return;
                }
                
                categoriesMessage.innerHTML = '<strong>Available Product Categories:</strong><br>';
                
                // Create styled category container
                const categoryContainer = document.createElement('div');
                categoryContainer.style.display = 'flex';
                categoryContainer.style.flexWrap = 'wrap';
                categoryContainer.style.gap = '10px';
                categoryContainer.style.marginTop = '10px';
                
                // Create category buttons with nice styling
                categories.forEach(category => {
                    const categoryButton = document.createElement('div');
                    categoryButton.classList.add('category-button');
                    categoryButton.style.backgroundColor = '#f0f8ff';
                    categoryButton.style.border = '1px solid #4285f4';
                    categoryButton.style.borderRadius = '20px';
                    categoryButton.style.padding = '8px 15px';
                    categoryButton.style.margin = '5px';
                    categoryButton.style.cursor = 'pointer';
                    categoryButton.style.textTransform = 'capitalize';
                    categoryButton.style.transition = 'all 0.3s ease';
                    categoryButton.style.display = 'flex';
                    categoryButton.style.alignItems = 'center';
                    categoryButton.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                    
                    // Add icon based on category
                    let icon = 'üì¶';
                    if (category === 'beauty') icon = 'üíÑ';
                    if (category === 'fragrances') icon = 'üß¥';
                    if (category === 'furniture') icon = 'ü™ë';
                    if (category === 'groceries') icon = 'üõí';
                    
                    categoryButton.innerHTML = `<span style="margin-right: 8px; font-size: 1.2em;">${icon}</span> ${category}`;
                    
                    // Add hover effect
                    categoryButton.addEventListener('mouseover', function() {
                        this.style.backgroundColor = '#4285f4';
                        this.style.color = 'white';
                        this.style.transform = 'translateY(-2px)';
                        this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                    });
                    
                    categoryButton.addEventListener('mouseout', function() {
                        this.style.backgroundColor = '#f0f8ff';
                        this.style.color = 'black';
                        this.style.transform = 'translateY(0)';
                        this.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                    });
                    
                    // Add click handler
                    categoryButton.addEventListener('click', function() {
                        showProductsByCategory(category);
                    });
                    
                    categoryContainer.appendChild(categoryButton);
                });
                
                categoriesMessage.appendChild(categoryContainer);
                messagesContainer.appendChild(categoriesMessage);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 1000);
        }

        // Function to extract and clean up categories from product data
        function extractCategories(products) {
            // Filter out undefined/null categories and remove duplicates
            return [...new Set(products
                .map(product => product.category)
                .filter(category => category && category.trim() !== '')
            )].sort();
        }

        // Updated getCategories function with better handling
        function getCategories() {
            if (!allProducts) {
                showErrorMessage("Product data is still loading. Please try again in a moment.");
                return;
            }
            
            // Extract unique categories from products with better error handling
            const categories = extractCategories(allProducts.products);
            
            if (categories.length === 0) {
                showErrorMessage("No product categories available.");
                return;
            }
            
            const messagesContainer = document.querySelector('.chat-messages');
            
            // Create message with header
            const categoryMessage = document.createElement('div');
            categoryMessage.classList.add('message', 'bot-message');
            categoryMessage.innerHTML = '<strong>Available Categories:</strong><br>';
            
            // Create container for category buttons with product-suggestions class
            const categoryButtons = document.createElement('div');
            categoryButtons.classList.add('category-buttons', 'product-suggestions');
            
            // Add each category as a clickable button
            categories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.classList.add('quick-reply-btn');
                
                button.onclick = function() {
                    // Show selected category
                    const userMessage = document.createElement('div');
                    userMessage.classList.add('message', 'user-message');
                    userMessage.textContent = `I want to browse: ${category}`;
                    messagesContainer.appendChild(userMessage);
                    
                    // Display products for selected category
                    showProductsByCategory(category);
                };
                
                categoryButtons.appendChild(button);
            });
            
            // Add buttons to message
            categoryMessage.appendChild(categoryButtons);
            messagesContainer.appendChild(categoryMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Updated getCategories function to use local JSON data
        function getCategories() {
            if (!allProducts) {
                showErrorMessage("Product data is still loading. Please try again in a moment.");
                return;
            }
            
            // Extract unique categories from products
            const categories = [...new Set(allProducts.products.map(product => product.category))];
            
            const messagesContainer = document.querySelector('.chat-messages');
            
            // Create message with header
            const categoryMessage = document.createElement('div');
            categoryMessage.classList.add('message', 'bot-message');
            categoryMessage.innerHTML = '<strong>Available Categories:</strong><br>';
            
            // Create container for category buttons
            const categoryButtons = document.createElement('div');
            categoryButtons.classList.add('category-buttons');
            categoryButtons.style.display = 'flex';
            categoryButtons.style.flexWrap = 'wrap';
            categoryButtons.style.gap = '8px';
            categoryButtons.style.marginTop = '10px';
            
            // Add each category as a clickable button
            categories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.style.backgroundColor = '#f0f0f0';
                button.style.border = '1px solid #ddd';
                button.style.borderRadius = '20px';
                button.style.padding = '6px 12px';
                button.style.margin = '4px';
                button.style.cursor = 'pointer';
                
                button.onclick = function() {
                    // Show selected category
                    const userMessage = document.createElement('div');
                    userMessage.classList.add('message', 'user-message');
                    userMessage.textContent = `I want to browse: ${category}`;
                    messagesContainer.appendChild(userMessage);
                    
                    // Display products for selected category
                    showProductsByCategory(category);
                };
                
                categoryButtons.appendChild(button);
            });
            
            // Add buttons to message
            categoryMessage.appendChild(categoryButtons);
            messagesContainer.appendChild(categoryMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Updated function to display products from selected category
        function showProductsByCategory(category) {
            const messagesContainer = document.querySelector('.chat-messages');
            
            // Filter products by category with better error handling
            const categoryProducts = allProducts.products.filter(
                product => product.category === category
            );
            
            // Create loading message
            const loadingMessage = document.createElement('div');
            loadingMessage.classList.add('message', 'bot-message');
            loadingMessage.textContent = `Finding ${category} products for you...`;
            messagesContainer.appendChild(loadingMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            setTimeout(() => {
                // Replace loading message
                messagesContainer.removeChild(loadingMessage);
                
                // Create products message
                const productsMessage = document.createElement('div');
                productsMessage.classList.add('message', 'bot-message');
                
                if (categoryProducts.length === 0) {
                    productsMessage.textContent = `Sorry, no ${category} products found.`;
                } else {
                    productsMessage.innerHTML = `<strong>Here are some ${category} products:</strong><br>`;
                    
                    // Create product list container using product-suggestions class
                    const productListContainer = document.createElement('div');
                    productListContainer.classList.add('product-list', 'product-suggestions');
                    
                    // Add top 5 products or all if less than 5
                    const topProducts = categoryProducts.slice(0, 5);
                    topProducts.forEach(product => {
                        // Create a product card using the existing CSS classes
                        const productItem = document.createElement('div');
                        productItem.classList.add('product-card');
                        
                        // Handle price and discount with error checking
                        const price = product.price || 0;
                        const discountPercentage = product.discountPercentage || 0;
                        const discountedPrice = (price * (1 - discountPercentage/100)).toFixed(2);
                        
                        // Create product HTML with appropriate fallbacks
                        productItem.innerHTML = `
                            <div class="product-image">
                                ${product.thumbnail ? 
                                    `<img src="${product.thumbnail}" alt="${product.title || 'Product'}">` : 
                                    '<div class="no-image">No image</div>'}
                            </div>
                            <div class="product-info">
                                <h4>${product.title || 'Untitled Product'}</h4>
                                <div class="product-price">
                                    ${discountPercentage > 0 ? 
                                        `<span class="original-price">$${price.toFixed(2)}</span>
                                        <span class="discount-price">$${discountedPrice}</span>` : 
                                        `<span class="regular-price">$${price.toFixed(2)}</span>`}
                                </div>
                            </div>
                        `;
                        
                        productItem.onclick = function() {
                            showProductDetails(product);
                        };
                        
                        productListContainer.appendChild(productItem);
                    });
                    
                    productsMessage.appendChild(productListContainer);
                    
                    if (categoryProducts.length > 5) {
                        const showMoreButton = document.createElement('button');
                        showMoreButton.textContent = 'Show More Products';
                        showMoreButton.classList.add('quick-reply-btn');
                        
                        showMoreButton.onclick = function() {
                            showAllProductsByCategory(category);
                        };
                        
                        productsMessage.appendChild(showMoreButton);
                    }
                }
                
                messagesContainer.appendChild(productsMessage);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 800);
        }

        // Enhanced function to display product details
        function showProductDetails(product) {
            const messagesContainer = document.querySelector('.chat-messages');
            
            const productDetailMessage = document.createElement('div');
            productDetailMessage.classList.add('message', 'bot-message');
            
            // Handle potential missing data with fallbacks
            const title = product.title || 'Untitled Product';
            const description = product.description || 'No description available';
            const price = product.price || 0;
            const discountPercentage = product.discountPercentage || 0;
            const rating = product.rating || 0;
            const stock = product.stock || 0;
            const discountedPrice = (price * (1 - discountPercentage/100)).toFixed(2);
            
            let discountInfo = '';
            if (discountPercentage > 0) {
                discountInfo = `<span style="color: #ff6b6b; font-weight: bold;">Save ${discountPercentage.toFixed(1)}%!</span>`;
            }
            
            // Create a more robust product detail display
            productDetailMessage.innerHTML = `
                <div class="product-detail">
                    ${product.thumbnail ? 
                        `<img src="${product.thumbnail}" alt="${title}" class="product-detail-image">` : 
                        '<div class="no-image">No image available</div>'}
                    <div class="product-detail-info">
                        <h3>${title}</h3>
                        <p class="product-description">${description}</p>
                        <div class="product-meta">
                            <div class="product-pricing">
                                <span class="current-price">$${discountedPrice}</span>
                                ${discountPercentage > 0 ? 
                                    `<span class="original-price">$${price.toFixed(2)}</span> ${discountInfo}` : ''}
                            </div>
                            <div class="product-stats">
                                ${rating ? `<span>Rating: ${rating}/5 ‚≠ê</span>` : ''}
                                ${stock ? `<span>${stock} in stock</span>` : '<span>Out of stock</span>'}
                            </div>
                        </div>
                        
                        ${product.brand ? `<p class="product-brand">Brand: ${product.brand}</p>` : ''}
                        ${product.warrantyInformation ? `<p class="product-warranty">Warranty: ${product.warrantyInformation}</p>` : ''}
                        ${product.shippingInformation ? `<p class="product-shipping">Shipping: ${product.shippingInformation}</p>` : ''}
                    </div>
                </div>
                <div class="quick-replies" style="margin-top: 10px;">
                    <button class="quick-reply-btn" onclick="addToCart('${product.id}')">
                        <i class="fas fa-cart-plus"></i> Add to Cart
                    </button>
                    <button class="quick-reply-btn">
                        <i class="fas fa-heart"></i> Save for Later
                    </button>
                    <button class="quick-reply-btn" onclick="getRelatedProducts('${product.category}', '${product.id}')">
                        <i class="fas fa-search"></i> Similar Products
                    </button>
                </div>
            `;
            
            messagesContainer.appendChild(productDetailMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Function to show all products from a category
        function showAllProductsByCategory(category) {
            const messagesContainer = document.querySelector('.chat-messages');
            const categoryProducts = allProducts.products.filter(product => product.category === category);
            
            const allProductsMessage = document.createElement('div');
            allProductsMessage.classList.add('message', 'bot-message');
            allProductsMessage.innerHTML = `<strong>All ${category} products:</strong><br>`;
            
            const productGrid = document.createElement('div');
            productGrid.style.display = 'grid';
            productGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
            productGrid.style.gap = '8px';
            productGrid.style.marginTop = '10px';
            
            categoryProducts.forEach(product => {
                const productItem = document.createElement('div');
                productItem.classList.add('product-item');
                productItem.style.padding = '8px';
                productItem.style.border = '1px solid #eaeaea';
                productItem.style.borderRadius = '8px';
                productItem.style.cursor = 'pointer';
                
                // Calculate discount price
                const discountedPrice = (product.price * (1 - product.discountPercentage/100)).toFixed(2);
                
                productItem.innerHTML = `
                    <div>
                        <strong>${product.title}</strong>
                        <div style="font-size: 0.9em;">$${discountedPrice}</div>
                    </div>
                `;
                
                productItem.onclick = function() {
                    showProductDetails(product);
                };
                
                productGrid.appendChild(productItem);
            });
            
            allProductsMessage.appendChild(productGrid);
            messagesContainer.appendChild(allProductsMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Helper function for error messages
        function showErrorMessage(message) {
            const messagesContainer = document.querySelector('.chat-messages');
            const errorMessage = document.createElement('div');
            errorMessage.classList.add('message', 'bot-message');
            errorMessage.textContent = message;
            messagesContainer.appendChild(errorMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Add to Cart functionality
        function addToCart(productId) {
            const messagesContainer = document.querySelector('.chat-messages');
            const confirmationMessage = document.createElement('div');
            confirmationMessage.classList.add('message', 'bot-message');
            confirmationMessage.innerHTML = `Product added to cart! <a href="#">View Cart</a>`;
            messagesContainer.appendChild(confirmationMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Function to handle JSON downloading - keep the existing one
        function downloadProductsJSON() {
            const messagesContainer = document.querySelector('.chat-messages');
            
            // Show user request in chat
            const userMessage = document.createElement('div');
            userMessage.classList.add('message', 'user-message');
            userMessage.textContent = "I need the product data as JSON";
            messagesContainer.appendChild(userMessage);
            
            // Show loading message
            const loadingMessage = document.createElement('div');
            loadingMessage.classList.add('message', 'bot-message');
            loadingMessage.textContent = "Fetching product data for you...";
            messagesContainer.appendChild(loadingMessage);
            
            // Create download from local data
            if (allProducts) {
                setTimeout(() => {
                    messagesContainer.removeChild(loadingMessage);
                    
                    // Create a JSON blob from the data
                    const jsonData = JSON.stringify(allProducts, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    
                    // Create a URL for the blob
                    const url = URL.createObjectURL(blob);
                    
                    // Add download message and button to the chat
                    const downloadMessage = document.createElement('div');
                    downloadMessage.classList.add('message', 'bot-message');
                    
                    // Create download link
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    downloadLink.download = 'products.json';
                    downloadLink.className = 'quick-reply-btn';
                    downloadLink.innerHTML = '<i class="fas fa-download"></i> Download Products JSON';
                    downloadLink.style.display = 'inline-block';
                    downloadLink.style.textDecoration = 'none';
                    downloadLink.style.margin = '10px 0';
                    
                    downloadMessage.innerHTML = 'I\'ve fetched the product data for you. Click below to download:';
                    downloadMessage.appendChild(document.createElement('br'));
                    downloadMessage.appendChild(downloadLink);
                    
                    messagesContainer.appendChild(downloadMessage);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    // Clean up the URL object after download
                    downloadLink.addEventListener('click', () => {
                        setTimeout(() => {
                            URL.revokeObjectURL(url);
                        }, 100);
                    });
                }, 1000);
            } else {
                loadProductsData().then(() => {
                    downloadProductsJSON();
                });
            }
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Function to show related products from the same category
        function getRelatedProducts(category, currentProductId) {
            const messagesContainer = document.querySelector('.chat-messages');
            
            // Filter products by category and exclude current product
            const relatedProducts = allProducts.products.filter(
                product => product.category === category && product.id != currentProductId
            );
            
            // Create a message for related products
            const relatedMessage = document.createElement('div');
            relatedMessage.classList.add('message', 'bot-message');
            
            if (relatedProducts.length === 0) {
                relatedMessage.textContent = `No other ${category} products found.`;
            } else {
                relatedMessage.innerHTML = `<strong>You might also like:</strong><br>`;
                
                // Create product suggestions container
                const suggestionsContainer = document.createElement('div');
                suggestionsContainer.classList.add('product-suggestions');
                
                // Show up to 3 related products
                const suggestedProducts = relatedProducts.slice(0, 3);
                suggestedProducts.forEach(product => {
                    // Create a more compact suggestion card
                    const suggestionCard = document.createElement('div');
                    suggestionCard.classList.add('product-card');
                    
                    // Handle price and discount
                    const price = product.price || 0;
                    const discountPercentage = product.discountPercentage || 0;
                    const discountedPrice = (price * (1 - discountPercentage/100)).toFixed(2);
                    
                    suggestionCard.innerHTML = `
                        <div class="product-image">
                            ${product.thumbnail ? 
                                `<img src="${product.thumbnail}" alt="${product.title || 'Product'}">` : 
                                '<div class="no-image">No image</div>'}
                        </div>
                        <div class="product-info">
                            <h4>${product.title || 'Untitled Product'}</h4>
                            <p class="product-price">$${discountedPrice}</p>
                        </div>
                    `;
                    
                    suggestionCard.onclick = function() {
                        showProductDetails(product);
                    };
                    
                    suggestionsContainer.appendChild(suggestionCard);
                });
                
                relatedMessage.appendChild(suggestionsContainer);
            }
            
            messagesContainer.appendChild(relatedMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function toggleChat() {
            const chatContainer = document.querySelector('.chatbot-container');
            const openButton = document.querySelector('.open-chat-btn');
            
            if (chatContainer.style.display === 'none' || !chatContainer.style.display) {
                chatContainer.style.display = 'block';
                if (!allProducts) {
                    loadProductsData();
                }
            } else {
                chatContainer.style.display = 'none';
            }
        }

        // Handle chat input submissions
        document.querySelector('.chat-input button').addEventListener('click', function() {
            handleChatInput();
        });

        document.querySelector('.chat-input input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleChatInput();
            }
        });

        function handleChatInput() {
            const inputField = document.querySelector('.chat-input input');
            const userInput = inputField.value.trim();
            
            if (!userInput) return;
            
            const messagesContainer = document.querySelector('.chat-messages');
            
            // Add user message
            const userMessage = document.createElement('div');
            userMessage.classList.add('message', 'user-message');
            userMessage.textContent = userInput;
            messagesContainer.appendChild(userMessage);
            
            // Clear input field
            inputField.value = '';
            
            // Process the input
            processUserInput(userInput);
        }

        function processUserInput(input) {
            const lowercaseInput = input.toLowerCase();
            
            // Simple keyword matching for demo purposes
            if (lowercaseInput.includes('category') || lowercaseInput.includes('browse') || 
                lowercaseInput.includes('products') || lowercaseInput.includes('shop')) {
                getCategories();
            } 
            else if (lowercaseInput.includes('search') || lowercaseInput.includes('find') || 
                     lowercaseInput.includes('looking for')) {
                // Extract search terms by removing common prefixes
                const searchTerms = lowercaseInput
                    .replace(/search for|looking for|find|search|show me/gi, '')
                    .trim();
                
                if (searchTerms) {
                    searchProducts(searchTerms);
                } else {
                    // If no clear search terms, ask what they're looking for
                    showBotMessage("What type of product are you looking for?");
                }
            }
            else if (lowercaseInput.includes('help') || lowercaseInput.includes('faq')) {
                window.location.href = 'faq';
            }
            else if (lowercaseInput.includes('json') || lowercaseInput.includes('data')) {
                downloadProductsJSON();
            }
            else {
                // Default response
                searchProducts(input);
            }
        }

        // Search products based on user input
        function searchProducts(query) {
            if (!allProducts) {
                showErrorMessage("Product data is still loading. Please try again in a moment.");
                return;
            }
            
            const messagesContainer = document.querySelector('.chat-messages');
            
            // Create loading message
            const loadingMessage = document.createElement('div');
            loadingMessage.classList.add('message', 'bot-message');
            loadingMessage.textContent = `Searching for "${query}"...`;
            messagesContainer.appendChild(loadingMessage);
            
            setTimeout(() => {
                // Remove loading message
                messagesContainer.removeChild(loadingMessage);
                
                // Search in product titles, descriptions, and categories
                const results = allProducts.products.filter(product => {
                    // Handle potential missing data
                    const title = (product.title || '').toLowerCase();
                    const description = (product.description || '').toLowerCase();
                    const category = (product.category || '').toLowerCase();
                    const brand = (product.brand || '').toLowerCase();
                    
                    return title.includes(query.toLowerCase()) || 
                           description.includes(query.toLowerCase()) ||
                           category.includes(query.toLowerCase()) ||
                           brand.includes(query.toLowerCase());
                });
                
                if (results.length > 0) {
                    // Create results message
                    const resultsMessage = document.createElement('div');
                    resultsMessage.classList.add('message', 'bot-message');
                    resultsMessage.innerHTML = `<strong>I found ${results.length} products matching "${query}":</strong><br>`;
                    
                    const productListContainer = document.createElement('div');
                    productListContainer.classList.add('product-list', 'product-suggestions');
                    
                    // Show first 5 results
                    results.slice(0, 5).forEach(product => {
                        const productItem = document.createElement('div');
                        productItem.classList.add('product-card');
                        
                        // Handle price and discount with error checking
                        const price = product.price || 0;
                        const discountPercentage = product.discountPercentage || 0;
                        const discountedPrice = (price * (1 - discountPercentage/100)).toFixed(2);
                        
                        productItem.innerHTML = `
                            <div class="product-image">
                                ${product.thumbnail ? 
                                    `<img src="${product.thumbnail}" alt="${product.title || 'Product'}">` : 
                                    '<div class="no-image">No image</div>'}
                            </div>
                            <div class="product-info">
                                <h4>${product.title || 'Untitled Product'}</h4>
                                <div class="product-price">$${discountedPrice}</div>
                            </div>
                        `;
                        
                        productItem.onclick = function() {
                            showProductDetails(product);
                        };
                        
                        productListContainer.appendChild(productItem);
                    });
                    
                    resultsMessage.appendChild(productListContainer);
                    
                    if (results.length > 5) {
                        const showMoreButton = document.createElement('button');
                        showMoreButton.textContent = 'Show More Results';
                        showMoreButton.classList.add('quick-reply-btn');
                        
                        showMoreButton.onclick = function() {
                            // Show all search results
                            showAllSearchResults(query, results);
                        };
                        
                        resultsMessage.appendChild(showMoreButton);
                    }
                    
                    messagesContainer.appendChild(resultsMessage);
                } else {
                    // No results found
                    const noResultsMessage = document.createElement('div');
                    noResultsMessage.classList.add('message', 'bot-message');
                    noResultsMessage.innerHTML = `I couldn't find any products matching "${query}". Would you like to browse by category instead?<br><br>
                        <button class="quick-reply-btn" onclick="getCategories()">
                            <i class="fas fa-list"></i> Browse Categories
                        </button>`;
                    
                    messagesContainer.appendChild(noResultsMessage);
                }
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 800);
        }

        // Helper function to display a simple bot message
        function showBotMessage(message) {
            const messagesContainer = document.querySelector('.chat-messages');
            const botMessage = document.createElement('div');
            botMessage.classList.add('message', 'bot-message');
            botMessage.textContent = message;
            messagesContainer.appendChild(botMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addRetryButton() {
            const messagesContainer = document.querySelector('.chat-messages');
            const retryMessage = document.createElement('div');
            retryMessage.classList.add('message', 'bot-message');
            retryMessage.innerHTML = `
                Unable to load products. 
                <button class="quick-reply-btn" onclick="preloadProductData()">
                    <i class="fas fa-sync"></i> Retry Loading
                </button>
            `;
            messagesContainer.appendChild(retryMessage);
        }
    </script>
</body>
</html>