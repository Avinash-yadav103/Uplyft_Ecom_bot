<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopAssist - E-Commerce Chatbot</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <h1>ShopAssist</h1>
        <nav>
            <ul>
                <li><a href="">Home</a></li>
                <li><a href="">Products</a></li>
                <li><a href="">Cart</a></li>
                <li><a href="">Account</a></li>
            </ul>
        </nav>
    </header>

    Search using AI feature
    Testing hatana and checks hatana

    <div class="openbox">
        <button class="open-chat-btn" onClick=toggleChat()>
            <i class="fas fa-comments"></i> Chat with us
        </button>
    </div>

    <main>
        <div class="user-profile">
            <div class="user-avatar">
                <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?ixlib=rb-1.2.1&auto=format&fit=crop&w=250&q=80" alt="User Avatar">
            </div>
            <div class="user-info">
                <h3>Welcome, Alex!</h3>
                <p>Premium Member since 2023</p>
            </div>
        </div>

        <div class="chatbot-container">
            <div class="chatbot-header">
                <div class="bot-logo">
                    <img src="https://cdn-icons-png.flaticon.com/512/2021/2021646.png" alt="ShopAssist Logo">
                    <span class="status-indicator"></span>
                </div>
                <div class="bot-info">
                    <h2>ShopAssist</h2>
                    <p>Online</p>
                </div>
                <button class="close-btn" onClick=toggleChat()>
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="chat-messages">
                <div class="message bot-message">
                    👋 Hi Alex! Welcome to our store. How can I help you today?
                </div>
                
                <!-- Quick Replies Section -->
                <div class="quick-replies">
                    <button class="quick-reply-btn" onclick=getCategories()>
                        <i class="fas fa-tshirt"></i> Browse Products
                    </button>
                    <button class="quick-reply-btn">
                        <i class="fas fa-tag"></i> Today's Deals
                    </button>
                    <button class="quick-reply-btn">
                        <a href='faq'><i class="fas fa-question-circle"></i> Help & FAQ</a>
                    </button>
                    <button class="quick-reply-btn">
                        <i class="fas fa-headset"></i> Contact Support
                    </button>
                    <button class="quick-reply-btn" onclick="searchWithAI()">
                        <i class="fas fa-search"></i> Search with AI
                    </button>
                    <button class="quick-reply-btn" onclick="downloadProductsJSON()">
                        <i class="fas fa-file-download"></i> Get Products JSON
                    </button>
                </div>

            </div>
            
            <div class="chat-input">
                <input type="text" placeholder="Type your message here..." aria-label="Chat message">
                <button type="submit">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </main>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        // Enhanced product data loading with preload and retries
        let allProducts = null;
        let isLoadingProducts = false;
        let loadingAttempts = 0;
        const MAX_LOADING_ATTEMPTS = 3;

        // Add cart related variables
        let cart = [];
        let cartItemCount = 0;
        let cartTotal = 0;

        // Preload products as soon as the page loads
        document.addEventListener('DOMContentLoaded', function() {
            preloadProductData();
            
            // Show loading indicator in the chat immediately
            const messagesContainer = document.querySelector('.chat-messages');
            const loadingIndicator = document.createElement('div');
            loadingIndicator.classList.add('message', 'bot-message', 'loading-indicator');
            loadingIndicator.innerHTML = 'Loading product data... <div class="loading-spinner"></div>';
            loadingIndicator.id = 'loading-indicator';
            messagesContainer.appendChild(loadingIndicator);
        });

        // Preload function with retry capability
        async function preloadProductData() {
            if (isLoadingProducts || allProducts) return;
            
            isLoadingProducts = true;
            loadingAttempts++;
            
            try {
                // First try to load from local file
                const response = await fetch('/static/products.json');
                if (!response.ok) {
                    throw new Error(`Failed to load products from local file: ${response.status}`);
                }
                
                allProducts = await response.json();
                console.log("Products data loaded successfully from local file");
                
                // Remove loading indicator if it exists
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
                
                // Show success message
                showBotMessage("Product data loaded successfully! How can I help you today?");
                
                // Enable all chat buttons
                enableChatInteractions();
                
                isLoadingProducts = false;
            } catch (error) {
                console.error("Error loading products from local file:", error);
                
                // Try loading from DummyJSON API as fallback
                try {
                    console.log("Attempting to load from DummyJSON API...");
                    const dummyResponse = await fetch('https://dummyjson.com/products?limit=100');
                    if (!dummyResponse.ok) {
                        throw new Error(`Failed to load products from API: ${dummyResponse.status}`);
                    }
                    
                    allProducts = await dummyResponse.json();
                    console.log("Products data loaded successfully from DummyJSON API");
                    
                    // Remove loading indicator if it exists
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.remove();
                    }
                    
                    // Show success message
                    showBotMessage("Product data loaded successfully! How can I help you today?");
                    
                    // Enable all chat buttons
                    enableChatInteractions();
                    
                    isLoadingProducts = false;
                } catch (apiError) {
                    console.error("Error loading products from API:", apiError);
                    
                    if (loadingAttempts < MAX_LOADING_ATTEMPTS) {
                        // Retry loading after delay
                        isLoadingProducts = false;
                        setTimeout(preloadProductData, 2000);
                        
                        // Update loading message
                        const loadingIndicator = document.getElementById('loading-indicator');
                        if (loadingIndicator) {
                            loadingIndicator.innerHTML = `Retrying product data load (${loadingAttempts}/${MAX_LOADING_ATTEMPTS})... <div class="loading-spinner"></div>`;
                        }
                    } else {
                        // Max retries reached, show error and add retry button
                        const loadingIndicator = document.getElementById('loading-indicator');
                        if (loadingIndicator) {
                            loadingIndicator.remove();
                        }
                        
                        showErrorMessage("Unable to load product data. Please refresh the page or try again later.");
                        addRetryButton();
                        enableChatInteractions(); // Enable chat even though loading failed
                        isLoadingProducts = false;
                    }
                }
            }
        }

        // Enable all chat buttons after data is loaded
        function enableChatInteractions() {
            const buttons = document.querySelectorAll('.quick-reply-btn');
            buttons.forEach(button => {
                button.disabled = false;
            });
        }

        // Add CSS for loading spinner
        const style = document.createElement('style');
        style.textContent = `
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        `;
        document.head.appendChild(style);

        // Override the getCategories function to check data status
        function getCategories() {
            if (!allProducts) {
                if (!isLoadingProducts) {
                    preloadProductData();
                    showBotMessage("Loading product data now. Please wait a moment...");
                } else {
                    showBotMessage("Product data is still loading. Please wait a moment...");
                }
                return;
            }
            
            const messagesContainer = document.querySelector('.chat-messages');
            
            // Add user message
            const userMessage = document.createElement('div');
            userMessage.classList.add('message', 'user-message');
            userMessage.textContent = "I want to browse products";
            messagesContainer.appendChild(userMessage);
            
            // Create loading message
            const loadingMessage = document.createElement('div');
            loadingMessage.classList.add('message', 'bot-message');
            loadingMessage.textContent = "Finding product categories for you...";
            messagesContainer.appendChild(loadingMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            setTimeout(() => {
                // Remove loading message
                messagesContainer.removeChild(loadingMessage);
                
                // Extract unique categories
                let categories = [];
                if (allProducts.products) {
                    categories = [...new Set(allProducts.products.map(product => product.category))];
                } else if (Array.isArray(allProducts)) {
                    categories = [...new Set(allProducts.map(product => product.category))];
                }
                
                categories = categories.filter(category => category && category.trim() !== '').sort();
                
                // Create categories message
                const categoriesMessage = document.createElement('div');
                categoriesMessage.classList.add('message', 'bot-message');
                
                if (categories.length === 0) {
                    categoriesMessage.textContent = "I couldn't find any product categories. Please try again later.";
                    messagesContainer.appendChild(categoriesMessage);
                    return;
                }
                
                categoriesMessage.innerHTML = '<strong>Available Product Categories:</strong><br>';
                
                // Create styled category container
                const categoryContainer = document.createElement('div');
                categoryContainer.style.display = 'flex';
                categoryContainer.style.flexWrap = 'wrap';
                categoryContainer.style.gap = '10px';
                categoryContainer.style.marginTop = '10px';
                
                // Create category buttons with nice styling
                categories.forEach(category => {
                    const categoryButton = document.createElement('div');
                    categoryButton.classList.add('category-button');
                    categoryButton.style.backgroundColor = '#f0f8ff';
                    categoryButton.style.border = '1px solid #4285f4';
                    categoryButton.style.borderRadius = '20px';
                    categoryButton.style.padding = '8px 15px';
                    categoryButton.style.margin = '5px';
                    categoryButton.style.cursor = 'pointer';
                    categoryButton.style.textTransform = 'capitalize';
                    categoryButton.style.transition = 'all 0.3s ease';
                    categoryButton.style.display = 'flex';
                    categoryButton.style.alignItems = 'center';
                    categoryButton.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                    
                    // Add icon based on category
                    let icon = '📦';
                    if (category === 'beauty') icon = '💄';
                    if (category === 'fragrances') icon = '🧴';
                    if (category === 'furniture') icon = '🪑';
                    if (category === 'groceries') icon = '🛒';
                    
                    categoryButton.innerHTML = `<span style="margin-right: 8px; font-size: 1.2em;">${icon}</span> ${category}`;
                    
                    // Add hover effect
                    categoryButton.addEventListener('mouseover', function() {
                        this.style.backgroundColor = '#4285f4';
                        this.style.color = 'white';
                        this.style.transform = 'translateY(-2px)';
                        this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                    });
                    
                    categoryButton.addEventListener('mouseout', function() {
                        this.style.backgroundColor = '#f0f8ff';
                        this.style.color = 'black';
                        this.style.transform = 'translateY(0)';
                        this.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                    });
                    
                    // Add click handler
                    categoryButton.addEventListener('click', function() {
                        showProductsByCategory(category);
                    });
                    
                    categoryContainer.appendChild(categoryButton);
                });
                
                categoriesMessage.appendChild(categoryContainer);
                messagesContainer.appendChild(categoriesMessage);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 1000);
        }

        // Function to extract and clean up categories from product data
        function extractCategories(products) {
            // Filter out undefined/null categories and remove duplicates
            return [...new Set(products
                .map(product => product.category)
                .filter(category => category && category.trim() !== '')
            )].sort();
        }

        // Updated getCategories function with better handling
        function getCategories() {
            if (!allProducts) {
                showErrorMessage("Product data is still loading. Please try again in a moment.");
                return;
            }
            
            // Extract unique categories from products with better error handling
            const categories = extractCategories(allProducts.products);
            
            if (categories.length === 0) {
                showErrorMessage("No product categories available.");
                return;
            }
            
            const messagesContainer = document.querySelector('.chat-messages');
            
            // Create message with header
            const categoryMessage = document.createElement('div');
            categoryMessage.classList.add('message', 'bot-message');
            categoryMessage.innerHTML = '<strong>Available Categories:</strong><br>';
            
            // Create container for category buttons with product-suggestions class
            const categoryButtons = document.createElement('div');
            categoryButtons.classList.add('category-buttons', 'product-suggestions');
            
            // Add each category as a clickable button
            categories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.classList.add('quick-reply-btn');
                
                button.onclick = function() {
                    // Show selected category
                    const userMessage = document.createElement('div');
                    userMessage.classList.add('message', 'user-message');
                    userMessage.textContent = `I want to browse: ${category}`;
                    messagesContainer.appendChild(userMessage);
                    
                    // Display products for selected category
                    showProductsByCategory(category);
                };
                
                categoryButtons.appendChild(button);
            });
            
            // Add buttons to message
            categoryMessage.appendChild(categoryButtons);
            messagesContainer.appendChild(categoryMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Updated getCategories function to use local JSON data
        function getCategories() {
            if (!allProducts) {
                showErrorMessage("Product data is still loading. Please try again in a moment.");
                return;
            }
            
            // Extract unique categories from products
            const categories = [...new Set(allProducts.products.map(product => product.category))];
            
            const messagesContainer = document.querySelector('.chat-messages');
            
            // Create message with header
            const categoryMessage = document.createElement('div');
            categoryMessage.classList.add('message', 'bot-message');
            categoryMessage.innerHTML = '<strong>Available Categories:</strong><br>';
            
            // Create container for category buttons
            const categoryButtons = document.createElement('div');
            categoryButtons.classList.add('category-buttons');
            categoryButtons.style.display = 'flex';
            categoryButtons.style.flexWrap = 'wrap';
            categoryButtons.style.gap = '8px';
            categoryButtons.style.marginTop = '10px';
            
            // Add each category as a clickable button
            categories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.style.backgroundColor = '#f0f0f0';
                button.style.border = '1px solid #ddd';
                button.style.borderRadius = '20px';
                button.style.padding = '6px 12px';
                button.style.margin = '4px';
                button.style.cursor = 'pointer';
                
                button.onclick = function() {
                    // Show selected category
                    const userMessage = document.createElement('div');
                    userMessage.classList.add('message', 'user-message');
                    userMessage.textContent = `I want to browse: ${category}`;
                    messagesContainer.appendChild(userMessage);
                    
                    // Display products for selected category
                    showProductsByCategory(category);
                };
                
                categoryButtons.appendChild(button);
            });
            
            // Add buttons to message
            categoryMessage.appendChild(categoryButtons);
            messagesContainer.appendChild(categoryMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Updated function to display products from selected category
        function showProductsByCategory(category) {
            const messagesContainer = document.querySelector('.chat-messages');
            
            // Filter products by category with better error handling
            const categoryProducts = allProducts.products.filter(
                product => product.category === category
            );
            
            // Create loading message
            const loadingMessage = document.createElement('div');
            loadingMessage.classList.add('message', 'bot-message');
            loadingMessage.textContent = `Finding ${category} products for you...`;
            messagesContainer.appendChild(loadingMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            setTimeout(() => {
                // Replace loading message
                messagesContainer.removeChild(loadingMessage);
                
                // Create products message
                const productsMessage = document.createElement('div');
                productsMessage.classList.add('message', 'bot-message');
                
                if (categoryProducts.length === 0) {
                    productsMessage.textContent = `Sorry, no ${category} products found.`;
                } else {
                    productsMessage.innerHTML = `<strong>Here are some ${category} products:</strong><br>`;
                    
                    // Create product list container using product-suggestions class
                    const productListContainer = document.createElement('div');
                    productListContainer.classList.add('product-list', 'product-suggestions');
                    
                    // Add top 5 products or all if less than 5
                    const topProducts = categoryProducts.slice(0, 5);
                    topProducts.forEach(product => {
                        // Create a product card using the existing CSS classes
                        const productItem = document.createElement('div');
                        productItem.classList.add('product-card');
                        
                        // Handle price and discount with error checking
                        const price = product.price || 0;
                        const discountPercentage = product.discountPercentage || 0;
                        const discountedPrice = (price * (1 - discountPercentage/100)).toFixed(2);
                        
                        // Create product HTML with appropriate fallbacks
                        productItem.innerHTML = `
                            <div class="product-image">
                                ${product.thumbnail ? 
                                    `<img src="${product.thumbnail}" alt="${product.title || 'Product'}">` : 
                                    '<div class="no-image">No image</div>'}
                            </div>
                            <div class="product-info">
                                <h4>${product.title || 'Untitled Product'}</h4>
                                <div class="product-price">
                                    ${discountPercentage > 0 ? 
                                        `<span class="original-price">$${price.toFixed(2)}</span>
                                        <span class="discount-price">$${discountedPrice}</span>` : 
                                        `<span class="regular-price">$${price.toFixed(2)}</span>`}
                                </div>
                            </div>
                        `;
                        
                        productItem.onclick = function() {
                            showProductDetails(product);
                        };
                        
                        productListContainer.appendChild(productItem);
                    });
                    
                    productsMessage.appendChild(productListContainer);
                    
                    if (categoryProducts.length > 5) {
                        const showMoreButton = document.createElement('button');
                        showMoreButton.textContent = 'Show More Products';
                        showMoreButton.classList.add('quick-reply-btn');
                        
                        showMoreButton.onclick = function() {
                            showAllProductsByCategory(category);
                        };
                        
                        productsMessage.appendChild(showMoreButton);
                    }
                }
                
                messagesContainer.appendChild(productsMessage);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 800);
        }

        // Enhanced function to display product details
        function showProductDetails(product) {
            const messagesContainer = document.querySelector('.chat-messages');
            
            const productDetailMessage = document.createElement('div');
            productDetailMessage.classList.add('message', 'bot-message');
            
            // Handle potential missing data with fallbacks
            const title = product.title || 'Untitled Product';
            const description = product.description || 'No description available';
            const price = product.price || 0;
            const discountPercentage = product.discountPercentage || 0;
            const rating = product.rating || 0;
            const stock = product.stock || 0;
            const discountedPrice = (price * (1 - discountPercentage/100)).toFixed(2);
            
            let discountInfo = '';
            if (discountPercentage > 0) {
                discountInfo = `<span style="color: #ff6b6b; font-weight: bold;">Save ${discountPercentage.toFixed(1)}%!</span>`;
            }
            
            // Create a more robust product detail display
            productDetailMessage.innerHTML = `
                <div class="product-detail">
                    ${product.thumbnail ? 
                        `<img src="${product.thumbnail}" alt="${title}" class="product-detail-image">` : 
                        '<div class="no-image">No image available</div>'}
                    <div class="product-detail-info">
                        <h3>${title}</h3>
                        <p class="product-description">${description}</p>
                        <div class="product-meta">
                            <div class="product-pricing">
                                <span class="current-price">$${discountedPrice}</span>
                                ${discountPercentage > 0 ? 
                                    `<span class="original-price">$${price.toFixed(2)}</span> ${discountInfo}` : ''}
                            </div>
                            <div class="product-stats">
                                ${rating ? `<span>Rating: ${rating}/5 ⭐</span>` : ''}
                                ${stock ? `<span>${stock} in stock</span>` : '<span>Out of stock</span>'}
                            </div>
                        </div>
                        
                        ${product.brand ? `<p class="product-brand">Brand: ${product.brand}</p>` : ''}
                        ${product.warrantyInformation ? `<p class="product-warranty">Warranty: ${product.warrantyInformation}</p>` : ''}
                        ${product.shippingInformation ? `<p class="product-shipping">Shipping: ${product.shippingInformation}</p>` : ''}
                    </div>
                </div>
                <div class="quick-replies" style="margin-top: 10px;">
                    <button class="quick-reply-btn" onclick="addToCart('${product.id}')">
                        <i class="fas fa-cart-plus"></i> Add to Cart
                    </button>
                    <button class="quick-reply-btn">
                        <i class="fas fa-heart"></i> Save for Later
                    </button>
                    <button class="quick-reply-btn" onclick="getRelatedProducts('${product.category}', '${product.id}')">
                        <i class="fas fa-search"></i> Similar Products
                    </button>
                </div>
            `;
            
            messagesContainer.appendChild(productDetailMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Function to show all products from a category
        function showAllProductsByCategory(category) {
            const messagesContainer = document.querySelector('.chat-messages');
            const categoryProducts = allProducts.products.filter(product => product.category === category);
            
            const allProductsMessage = document.createElement('div');
            allProductsMessage.classList.add('message', 'bot-message');
            allProductsMessage.innerHTML = `<strong>All ${category} products:</strong><br>`;
            
            const productGrid = document.createElement('div');
            productGrid.style.display = 'grid';
            productGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
            productGrid.style.gap = '8px';
            productGrid.style.marginTop = '10px';
            
            categoryProducts.forEach(product => {
                const productItem = document.createElement('div');
                productItem.classList.add('product-item');
                productItem.style.padding = '8px';
                productItem.style.border = '1px solid #eaeaea';
                productItem.style.borderRadius = '8px';
                productItem.style.cursor = 'pointer';
                
                // Calculate discount price
                const discountedPrice = (product.price * (1 - product.discountPercentage/100)).toFixed(2);
                
                productItem.innerHTML = `
                    <div>
                        <strong>${product.title}</strong>
                        <div style="font-size: 0.9em;">$${discountedPrice}</div>
                    </div>
                `;
                
                productItem.onclick = function() {
                    showProductDetails(product);
                };
                
                productGrid.appendChild(productItem);
            });
            
            allProductsMessage.appendChild(productGrid);
            messagesContainer.appendChild(allProductsMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Helper function for error messages
        function showErrorMessage(message) {
            const messagesContainer = document.querySelector('.chat-messages');
            const errorMessage = document.createElement('div');
            errorMessage.classList.add('message', 'bot-message');
            errorMessage.textContent = message;
            messagesContainer.appendChild(errorMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Updated addToCart function that actually adds products to a cart
        function addToCart(productId) {
            if (!allProducts) {
                showErrorMessage("Product data is still loading. Please try again in a moment.");
                return;
            }
            
            // Find the product in the products data
            const product = allProducts.products.find(p => p.id == productId);
            
            if (!product) {
                showErrorMessage("Sorry, I couldn't find that product.");
                return;
            }
            
            // Check if product is already in cart
            const existingItem = cart.find(item => item.id == productId);
            
            if (existingItem) {
                // Increment quantity if already in cart
                existingItem.quantity += 1;
            } else {
                // Add new item to cart
                cart.push({
                    id: product.id,
                    title: product.title || 'Unknown Product',
                    price: product.price || 0,
                    discountPercentage: product.discountPercentage || 0,
                    thumbnail: product.thumbnail || null,
                    quantity: 1
                });
            }
            
            // Update cart count and total
            updateCartCountAndTotal();
            
            // Show confirmation message with view cart option
            const messagesContainer = document.querySelector('.chat-messages');
            const confirmationMessage = document.createElement('div');
            confirmationMessage.classList.add('message', 'bot-message');
            confirmationMessage.innerHTML = `
                <div class="cart-confirmation">
                    <p>Added to cart: ${product.title || 'Product'}</p>
                    <div class="cart-actions">
                        <button class="quick-reply-btn" onclick="continueShoppingAfterAdd()">
                            <i class="fas fa-shopping-bag"></i> Continue Shopping
                        </button>
                        <button class="quick-reply-btn" onclick="viewCart()">
                            <i class="fas fa-shopping-cart"></i> View Cart (${cartItemCount})
                        </button>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(confirmationMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Update the cart icon in the header
            updateCartIcon();
        }

        // Function to update cart count and total
        function updateCartCountAndTotal() {
            cartItemCount = cart.reduce((total, item) => total + item.quantity, 0);
            cartTotal = cart.reduce((total, item) => {
                const discountedPrice = item.price * (1 - item.discountPercentage/100);
                return total + (discountedPrice * item.quantity);
            }, 0);
        }

        // Function to update the cart icon
        function updateCartIcon() {
            // Check if cart icon exists, if not create it
            let cartIcon = document.querySelector('.cart-icon');
            
            if (!cartIcon) {
                // Create cart icon in header
                const nav = document.querySelector('nav ul');
                const cartLi = document.createElement('li');
                cartLi.classList.add('cart-icon-container');
                cartLi.innerHTML = `
                    <a href="#" onclick="viewCart(); return false;" class="cart-icon">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-count">0</span>
                    </a>
                `;
                nav.appendChild(cartLi);
                
                // Add styles for cart icon
                const style = document.createElement('style');
                style.textContent = `
                    .cart-icon-container {
                        position: relative;
                    }
                    .cart-icon {
                        display: flex;
                        align-items: center;
                    }
                    .cart-count {
                        position: absolute;
                        top: -8px;
                        right: -8px;
                        background-color: #ff6b6b;
                        color: white;
                        border-radius: 50%;
                        width: 20px;
                        height: 20px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 12px;
                        font-weight: bold;
                    }
                    .cart-empty {
                        display: none;
                    }
                    .cart-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 15px;
                        margin-bottom: 15px;
                    }
                    .cart-table th, .cart-table td {
                        padding: 8px;
                        text-align: left;
                        border-bottom: 1px solid #ddd;
                    }
                    .cart-table th {
                        background-color: #f5f5f5;
                    }
                    .cart-product {
                        display: flex;
                        align-items: center;
                    }
                    .cart-product img {
                        width: 40px;
                        height: 40px;
                        object-fit: cover;
                        margin-right: 10px;
                        border-radius: 4px;
                    }
                    .quantity-control {
                        display: flex;
                        align-items: center;
                    }
                    .quantity-control button {
                        width: 25px;
                        height: 25px;
                        border: 1px solid #ddd;
                        background: white;
                        font-weight: bold;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    .quantity-control span {
                        margin: 0 8px;
                    }
                    .cart-summary {
                        margin-top: 15px;
                        padding: 15px;
                        background-color: #f9f9f9;
                        border-radius: 8px;
                    }
                    .cart-total {
                        font-size: 18px;
                        font-weight: bold;
                        margin-bottom: 10px;
                    }
                    .checkout-button {
                        background-color: #4CAF50;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-weight: bold;
                        transition: background-color 0.2s;
                    }
                    .checkout-button:hover {
                        background-color: #45a049;
                    }
                    .empty-cart-message {
                        text-align: center;
                        margin: 20px 0;
                        color: #666;
                    }
                    .remove-btn {
                        color: #ff6b6b;
                        cursor: pointer;
                        background: none;
                        border: none;
                        font-size: 16px;
                    }
                `;
                document.head.appendChild(style);
                
                cartIcon = document.querySelector('.cart-icon');
            }
            
            // Update cart count
            const cartCountElement = document.querySelector('.cart-count');
            if (cartCountElement) {
                cartCountElement.textContent = cartItemCount;
                
                // Show/hide count based on whether cart has items
                if (cartItemCount > 0) {
                    cartCountElement.classList.remove('cart-empty');
                } else {
                    cartCountElement.classList.add('cart-empty');
                }
            }
        }

        // Function to view the cart contents
        function viewCart() {
            const messagesContainer = document.querySelector('.chat-messages');
            
            // Add user message
            const userMessage = document.createElement('div');
            userMessage.classList.add('message', 'user-message');
            userMessage.textContent = "Show my shopping cart";
            messagesContainer.appendChild(userMessage);
            
            // Create cart view message
            const cartMessage = document.createElement('div');
            cartMessage.classList.add('message', 'bot-message');
            
            if (cart.length === 0) {
                // Empty cart message
                cartMessage.innerHTML = `
                    <div class="empty-cart-message">
                        <i class="fas fa-shopping-cart" style="font-size: 36px; color: #ddd; margin-bottom: 10px;"></i>
                        <p>Your cart is empty</p>
                        <button class="quick-reply-btn" onclick="getCategories()">
                            <i class="fas fa-shopping-bag"></i> Start Shopping
                        </button>
                    </div>
                `;
            } else {
                // Cart with items
                cartMessage.innerHTML = `<strong>Your Shopping Cart:</strong>`;
                
                // Create cart table
                const cartTable = document.createElement('table');
                cartTable.classList.add('cart-table');
                
                // Add table header
                cartTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Total</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="cart-items">
                    </tbody>
                `;
                
                const cartBody = cartTable.querySelector('#cart-items');
                
                // Add items to table
                cart.forEach(item => {
                    const discountedPrice = (item.price * (1 - item.discountPercentage/100)).toFixed(2);
                    const itemTotal = (discountedPrice * item.quantity).toFixed(2);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="cart-product">
                                ${item.thumbnail ? 
                                    `<img src="${item.thumbnail}" alt="${item.title}">` : 
                                    '<div class="no-image" style="width:40px;height:40px;background:#eee;"></div>'}
                                <div>${item.title}</div>
                            </div>
                        </td>
                        <td>$${discountedPrice}</td>
                        <td>
                            <div class="quantity-control">
                                <button onclick="updateCartItemQuantity(${item.id}, -1)">-</button>
                                <span>${item.quantity}</span>
                                <button onclick="updateCartItemQuantity(${item.id}, 1)">+</button>
                            </div>
                        </td>
                        <td>$${itemTotal}</td>
                        <td><button class="remove-btn" onclick="removeFromCart(${item.id})"><i class="fas fa-trash"></i></button></td>
                    `;
                    
                    cartBody.appendChild(row);
                });
                
                cartMessage.appendChild(cartTable);
                
                // Add cart summary
                const cartSummary = document.createElement('div');
                cartSummary.classList.add('cart-summary');
                cartSummary.innerHTML = `
                    <div class="cart-total">Total: $${cartTotal.toFixed(2)}</div>
                    <div style="display: flex; gap: 10px;">
                        <button class="checkout-button" onclick="proceedToCheckout()">
                            <i class="fas fa-credit-card"></i> Checkout
                        </button>
                        <button class="quick-reply-btn" onclick="clearCart()">
                            <i class="fas fa-trash"></i> Clear Cart
                        </button>
                        <button class="quick-reply-btn" onclick="continueShopping()">
                            <i class="fas fa-arrow-left"></i> Continue Shopping
                        </button>
                    </div>
                `;
                
                cartMessage.appendChild(cartSummary);
            }
            
            messagesContainer.appendChild(cartMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Function to update item quantity in cart
        function updateCartItemQuantity(productId, change) {
            const item = cart.find(item => item.id == productId);
            if (!item) return;
            
            item.quantity += change;
            
            // Remove item if quantity becomes 0 or less
            if (item.quantity <= 0) {
                removeFromCart(productId);
                return;
            }
            
            // Update cart count and total
            updateCartCountAndTotal();
            updateCartIcon();
            
            // Refresh cart view
            viewCart();
        }

        // Function to remove item from cart
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id != productId);
            
            // Update cart count and total
            updateCartCountAndTotal();
            updateCartIcon();
            
            // Refresh cart view
            viewCart();
        }

        // Function to clear the entire cart
        function clearCart() {
            cart = [];
            updateCartCountAndTotal();
            updateCartIcon();
            
            // Show empty cart
            viewCart();
        }

        // Function to continue shopping
        function continueShopping() {
            const messagesContainer = document.querySelector('.chat-messages');
            
            const botMessage = document.createElement('div');
            botMessage.classList.add('message', 'bot-message');
            botMessage.innerHTML = `
                What would you like to shop for?
                <div style="margin-top: 10px;">
                    <button class="quick-reply-btn" onclick="getCategories()">
                        <i class="fas fa-list"></i> Browse Categories
                    </button>
                    <button class="quick-reply-btn" onclick="showPopularProducts()">
                        <i class="fas fa-fire"></i> Popular Items
                    </button>
                </div>
            `;
            
            messagesContainer.appendChild(botMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Continue shopping after adding to cart
        function continueShoppingAfterAdd() {
            continueShoppingbotMessage("Item added to your cart! What else would you like to shop for?");
        }

        // Function to proceed to checkout
        function proceedToCheckout() {
            const messagesContainer = document.querySelector('.chat-messages');
            
            const checkoutMessage = document.createElement('div');
            checkoutMessage.classList.add('message', 'bot-message');
            checkoutMessage.innerHTML = `
                <div style="text-align: center;">
                    <i class="fas fa-check-circle" style="font-size: 36px; color: #4CAF50; margin-bottom: 10px;"></i>
                    <h3>Thank you for your order!</h3>
                    <p>Your order has been placed successfully.</p>
                    <p>Order #: ${Math.floor(Math.random() * 100000)}</p>
                    <p>Total: $${cartTotal.toFixed(2)}</p>
                    <p style="margin-top: 15px;">A confirmation email has been sent to your registered email address.</p>
                    <button class="quick-reply-btn" onclick="finishCheckout()">
                        <i class="fas fa-thumbs-up"></i> Got it!
                    </button>
                </div>
            `;
            
            messagesContainer.appendChild(checkoutMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Clear cart after successful checkout
            cart = [];
            updateCartCountAndTotal();
            updateCartIcon();
        }

        // Function after checkout is complete
        function finishCheckout() {
            const messagesContainer = document.querySelector('.chat-messages');
            
            const thankYouMessage = document.createElement('div');
            thankYouMessage.classList.add('message', 'bot-message');
            thankYouMessage.textContent = "Thanks for shopping with us! Is there anything else I can help you with?";
            
            messagesContainer.appendChild(thankYouMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Function to show popular products (optional feature)
        function showPopularProducts() {
            if (!allProducts) {
                showErrorMessage("Product data is still loading. Please try again in a moment.");
                return;
            }
            
            const messagesContainer = document.querySelector('.chat-messages');
            
            // Create loading message
            const loadingMessage = document.createElement('div');
            loadingMessage.classList.add('message', 'bot-message');
            loadingMessage.textContent = "Finding popular products...";
            messagesContainer.appendChild(loadingMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            setTimeout(() => {
                // Remove loading message
                messagesContainer.removeChild(loadingMessage);
                
                // Sort products by rating and get top rated
                const popularProducts = [...allProducts.products]
                    .filter(product => product.rating)
                    .sort((a, b) => b.rating - a.rating)
                    .slice(0, 5);
                
                if (popularProducts.length === 0) {
                    showBotMessage("Sorry, I couldn't find any popular products right now.");
                    return;
                }
                
                // Display popular products
                const productsMessage = document.createElement('div');
                productsMessage.classList.add('message', 'bot-message');
                productsMessage.innerHTML = "<strong>Our Top Rated Products:</strong><br>";
                
                const productList = document.createElement('div');
                productList.classList.add('product-list', 'product-suggestions');
                
                popularProducts.forEach(product => {
                    // Create a product card
                    const productItem = document.createElement('div');
                    productItem.classList.add('product-card');
                    
                    // Calculate discount
                    const price = product.price || 0;
                    const discountPercentage = product.discountPercentage || 0;
                    const discountedPrice = (price * (1 - discountPercentage/100)).toFixed(2);
                    
                    productItem.innerHTML = `
                        <div class="product-image">
                            ${product.thumbnail ? 
                                `<img src="${product.thumbnail}" alt="${product.title || 'Product'}">` : 
                                '<div class="no-image">No image</div>'}
                        </div>
                        <div class="product-info">
                            <h4>${product.title || 'Untitled Product'}</h4>
                            <div>Rating: ${product.rating.toFixed(1)} ⭐</div>
                            <div class="product-price">$${discountedPrice}</div>
                        </div>
                    `;
                    
                    productItem.onclick = function() {
                        showProductDetails(product);
                    };
                    
                    productList.appendChild(productItem);
                });
                
                productsMessage.appendChild(productList);
                messagesContainer.appendChild(productsMessage);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 800);
        }

        // Add toggle chat functionality
        function toggleChat() {
            const chatbotContainer = document.querySelector('.chatbot-container');
            const openChatBtn = document.querySelector('.open-chat-btn');
            
            if (chatbotContainer.style.display === 'none' || !chatbotContainer.style.display) {
                // Show chat
                chatbotContainer.style.display = 'block';
                openChatBtn.style.display = 'none';
                
                // Scroll to bottom of chat
                const messagesContainer = document.querySelector('.chat-messages');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
                
                // Ensure accessibility is set up
                enhanceChatAccessibility();
                
                // Focus on input when chat opens
                setTimeout(() => {
                    const chatInput = document.querySelector('.chat-input input');
                    if (chatInput) chatInput.focus();
                }, 100);
                
                // Announce to screen readers that chat is open
                const announcer = document.createElement('div');
                announcer.setAttribute('aria-live', 'assertive');
                announcer.className = 'sr-only';
                announcer.textContent = 'Chat window opened';
                document.body.appendChild(announcer);
                setTimeout(() => document.body.removeChild(announcer), 1000);
            } else {
                // Hide chat
                chatbotContainer.style.display = 'none';
                openChatBtn.style.display = 'flex';
                
                // Announce to screen readers that chat is closed
                const announcer = document.createElement('div');
                announcer.setAttribute('aria-live', 'assertive');
                announcer.className = 'sr-only';
                announcer.textContent = 'Chat window closed';
                document.body.appendChild(announcer);
                setTimeout(() => document.body.removeChild(announcer), 1000);
            }
        }
        
        // Initialize chat state on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial chat state - hidden by default
            const chatbotContainer = document.querySelector('.chatbot-container');
            if (chatbotContainer) {
                chatbotContainer.style.display = 'none';
            }
        });

        // Add these styles to your existing style element or create a new one
        const scrollStyles = document.createElement('style');
        scrollStyles.textContent = `
            .chat-messages {
                overflow-y: auto;
                scrollbar-width: thin;
                scrollbar-color: #6b48ff #f0f0f0;
                scroll-behavior: smooth;
                max-height: 400px; /* Set a fixed height for scrolling */
                padding-right: 10px; /* Space for scrollbar */
            }
            
            .chat-messages::-webkit-scrollbar {
                width: 8px;
            }
            
            .chat-messages::-webkit-scrollbar-track {
                background: #f0f0f0;
                border-radius: 10px;
            }
            
            .chat-messages::-webkit-scrollbar-thumb {
                background-color: #6b48ff;
                border-radius: 10px;
            }
            
            .scroll-to-bottom {
                position: absolute;
                bottom: 70px;
                right: 20px;
                background: #6b48ff;
                color: white;
                border: none;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                transition: all 0.2s;
                opacity: 0;
                pointer-events: none;
                z-index: 100;
            }
            
            .scroll-to-bottom.visible {
                opacity: 1;
                pointer-events: auto;
            }
            
            .scroll-to-bottom:hover {
                background: #5136e0;
                transform: translateY(-2px);
            }
            
            .new-message-indicator {
                position: absolute;
                bottom: 70px;
                right: 70px;
                background: #ff6b6b;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 12px;
                font-size: 12px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                opacity: 0;
                transition: opacity 0.3s;
                pointer-events: none;
            }
            
            .new-message-indicator.visible {
                opacity: 1;
            }

            /* Focus visible styles for accessibility */
            .quick-reply-btn:focus-visible,
            .chat-input input:focus-visible,
            .chat-input button:focus-visible {
                outline: 3px solid #6b48ff;
                outline-offset: 2px;
            }
        `;
        document.head.appendChild(scrollStyles);
    </script>
</body>
</html>